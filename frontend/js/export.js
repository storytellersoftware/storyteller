/*
  KEYBOARD-SHORTCUTS.js
  Contains all of our keyboard shortcuts
*/function setupKeyboardShortcuts(){var e={tab:9,enter:13,space:32,arrowLeft:37,arrowRight:39,arrowUp:38,arrowDown:40,comma:188,period:190};$("#playbackArea").keydown(function(t){if(!$("*:focus").is("textarea, input")){t.which==e.space&&playPause();if(t.which==e.period||t.which==e.arrowRight)playback.playing&&playPause(),stepForward(1);(t.which==e.comma||t.which==e.arrowLeft)&&stepBackward(1),t.which==e.arrowUp&&($("#speedSlider").slider("option","value",parseInt($("#speedSlider").slider("value"))+1),changeSpeed($("#speedSlider").slider("value")),clearTimeout($("#speedHolder").data("leaveTimeout")),$("#speedHolder").data("leaveTimeout",setTimeout(hideSpeedSlider,1500)),$("#speedHolder").is(":visible")||toggleSpeedSlider()),t.which==e.arrowDown&&($("#speedSlider").slider("option","value",parseInt($("#speedSlider").slider("value"))-1),changeSpeed($("#speedSlider").slider("value")),clearTimeout($("#speedHolder").data("leaveTimeout")),$("#speedHolder").data("leaveTimeout",setTimeout(hideSpeedSlider,1500)),$("#speedHolder").is(":visible")||toggleSpeedSlider())}}),$("#filterSelect").keydown(function(t){t.which==e.enter&&($("#filterSelect").dialog("close"),setupPlaybackInterface(),submitFilters())}),$("#loginbox").keydown(function(t){t.which==e.enter&&doLogin()}),$("#storyboardTitle").keydown(function(t){t.which==e.tab&&!$("#description").is(":visible")&&(t.preventDefault(),toggleDescription(),$("#storyboardDescription").focus())}),$("#storyboardDescription").keydown(function(t){t.which==e.tab&&(t.preventDefault(),toggleDescription(),$("#storyboardTitle").focus())})}function scratch(e){debug?$("#scratchpad").text(e):console.log(e)}function scratch_json(e){debug?scratch(JSON.stringify(e,null,2)):console.log(e)}function highlightElement(e,t,n){var r=$(e).css("background-color");$(e).animate({"background-color":n},{duration:100,easing:"linear",done:function(){setTimeout(function(){$(e).animate({"background-color":r},{duration:300})},t)}})}function fadeRemove(e){$("#"+e).stop().animate({opacity:"0"},{duration:100,easing:"linear",done:function(){this.remove()}})}function dateFormat(e){return isNaN(e.getDate())?"":(dstring="",dstring+=(e.getDate()<10?"0":"")+e.getDate(),dstring+="/",dstring+=(e.getMonth()+1<10?"0":"")+(e.getMonth()+1),dstring+="/",dstring+=e.getFullYear(),dstring+=" ",dstring+=(e.getHours()<10?"0":"")+e.getHours(),dstring+=":",dstring+=(e.getMinutes()<10?"0":"")+e.getMinutes(),dstring+=":",dstring+=(e.getSeconds()<10?"0":"")+e.getSeconds(),dstring)}function getSearchData(){var e={};if(window.location.search!=""&&window.location.search.length>1){var t=window.location.search.substring(1),n=t.split("&");$.each(n,function(t,n){var r=n.split("=");e[r[0]]=r[1]})}return e}function getSelectedElements(){var e=[],t=$(window.getSelection().getRangeAt(0).cloneContents()).children();for(var n=0;n<t.length;n++)e.push(t[n].id);return e}function highlightElements(e,t){var n=e;while(n!=t)$("#"+n).addClass("highlight"),n=$("#"+n).next().attr("id");$("#"+n).addClass("highlight")}function showGoodNotification(e,t){showNotification(e,t,"goodNotification")}function showBadNotification(e,t){showNotification(e,t,"badNotification")}function showNeutralNotification(e,t){showNotification(e,t,"neutralNotification")}function showNotification(e,t,n){hideNotification();var r=$("<div/>",{"class":n}).html(e);$("<button/>",{click:hideNotification,"class":"removeNotification"}).html("<image src='/img/xblack.svg'></image>").appendTo(r),$("#notification").hide().append(r).slideDown(),$("#notification").data("timeToShow",setTimeout(hideNotification,t))}function hideNotification(){clearTimeout($("#notification").data("timeToShow")),$("#notification").find("div").slideUp(function(){$("#notification").empty()})}function addComments(e,t){$.each(t,function(t,n){comments[e+"-"+n.eventID]=n})}function checkEventForComments(e){var t=e.clipNumber+"-"+e.eventID;return t in comments&&(e.commentID=t),e}function showComment(e){addToCommentSection("comment-"+e,"comment",comments[e].commentText,developerGroups[comments[e].developerGroupID].developers),playback.playing&&playPause(),highlightElements(playback.clipNumber+"-"+comments[e].startHighlightedEventID,playback.clipNumber+"-"+comments[e].endHighlightedEventID)}function hideComment(e){fadeRemove(e)}function showCommentSection(){$("#documents").css("width","70%"),$("#comments").show()}function hideCommentSection(){$("#documents").css("width","100%"),$("#comments").hide()}function showClipInfo(e){var t="<h2>"+storyboard.clips[e].name+"</h2>"+"<p>"+storyboard.clips[e].description+"</p>";addToCommentSection("clip-comment-"+e,"clip",t,developerGroups[storyboard.clips[e].developerGroupID].developers)}function hideClipInfo(e){fadeRemove("clip-comment-"+e)}function showDescription(e){var t="<h1>"+e.name+"</h1>"+"<p>"+e.description+"</p>";addToCommentSection("descriptionComment","description",t,developerGroups[e.developerGroupID].developers)}function addToCommentSection(e,t,n,r){var i=$("<div/>",{"class":"commentImgs"});$.each(r,function(e,t){var n=developers[t];$("<img/>",{src:n.gravatar+"&s=50"}).appendTo(i)});var s=$("<pre/>",{id:e,"class":t,style:"opacity: 0;"}).append(i).append(n).appendTo("#comments");t=="comment"?s.click(function(t){commentClick(e,$(this).attr("id"))}):t=="clip"?s.click(function(t){clipClick(e,$(this).attr("id"))}):s.click(function(e){storyboardClick()}),$("#comments").show(),$("#comments").scrollTo(s);var o=s.css("background-color");s.animate({"background-color":"#cade97",opacity:"1"},{duration:100,easing:"linear",done:function(){setTimeout(function(){s.animate({"background-color":o},{duration:300})},500)}})}function setMode(e){$("#mode").text(e),e=="clip creation"?$("header").attr("class","clipcreation"):$("header").attr("class","")}function setupMovement(){$("#locationSlider").slider({animate:!1,min:0,max:1,orientation:"horizontal",step:1,range:"min",slide:function(e,t){step(playback.relevantEvents[t.value],!1)}})}function step(e,t){playback.playing&&playPause();var n=playback.position<e,r=Math.abs(playback.position-e);n?stepForward(r,t):stepBackward(r,t)}function stepForward(e,t){function n(){return playback.orderOfEvents[playback.position].relevant}function r(){return events[playback.orderOfEvents[playback.position].eventID]}function i(){return playback.position>=playback.orderOfEvents.length}$(".highlight").removeClass("highlight"),t===undefined&&(t=!0);for(var s=0;s<e;s++){if(!doStepForward(t))break;while(!i()&&!n()&&doStepForward(t))s++;i()?$("#locationSlider").slider("value",playback.relevantEvents.length-1):($("#locationSlider").slider("value",playback.relevantEvents.indexOf(playback.position)),r()!==undefined&&($("#timestamp").text(dateFormat(new Date(r().timestamp))),changeDevGroup(r().developerGroupID)))}}function doStepForward(e){function t(){return events[playback.orderOfEvents[playback.position].eventID]}function n(){return playback.orderOfEvents[playback.position]}return playback.position>=playback.orderOfEvents.length?(playback.playing&&playPause(),!1):(t().type=="CREATE-DOCUMENT"?createDocument(n()):t().type=="INSERT"?insert(n(),!0,e):t().type=="DELETE"?del(n(),!0,e):t().type=="CLEAR"&&(hideClip(n()),showClipInfo(n().clipNumber+1),playback.clipNumber++),"commentID"in n()&&showComment(n().commentID),playback.position=playback.position+1,!0)}function stepBackward(e,t){function n(){return playback.orderOfEvents[playback.position].relevant}function r(){return events[playback.orderOfEvents[playback.position].eventID]}function i(){return playback.position<=0}$(".highlight").removeClass("highlight"),playback.playing&&playPause();if(playback.position==0)return;t===undefined&&(t=!0);for(var s=0;s<e;s++){if(!doStepBackward(t))break;while(!i()&&!n()){if(!doStepBackward(t))break;s++}$("#locationSlider").slider("value",playback.relevantEvents.indexOf(playback.position)),r()!==undefined&&($("#timestamp").text(dateFormat(new Date(r().timestamp))),changeDevGroup(r().developerGroupID))}}function doStepBackward(e){function t(){return events[playback.orderOfEvents[playback.position-1].eventID]}function n(){return playback.orderOfEvents[playback.position-1]}return playback.position==0?!1:(t().type=="CREATE-DOCUMENT"?delDocument(n()):t().type=="INSERT"?del(n(),!1,e):t().type=="DELETE"?insert(n(),!1,e):t().type=="CLEAR"&&(showClip(n()),hideClipInfo(n().clipNumber+1),playback.clipNumber--),"commentID"in n()&&hideComment("comment-"+n().commentID),playback.position=playback.position-1,!0)}function insert(e,t,n){var r=events[e.eventID],i=e.relevant;t||(r=events[playback.orderOfEvents[e.previousNeighborIndex].eventID],i=playback.orderOfEvents[e.previousNeighborIndex].relevant);var s=e.clipNumber+"-"+r.ID,o=e.clipNumber+"-"+r.documentID,u=e.clipNumber+"-"+r.previousNeighborID;$("#tab-"+o).trigger("click");var a=$("<span/>",{id:s,"class":"insert-event"}).text(r.eventData);$("#"+u).length==0?a.prependTo("#pre-"+o):a.insertAfter($("#"+u)),i&&n&&($("#"+s).css("background","#cade97"),setTimeout(function(){$("#"+s).css("background","transparent")},playback.speed)),$("#pre-"+o).scrollTo(a)}function del(e,t,n){var r=events[e.eventID],i=e.relevant;t&&(r=events[playback.orderOfEvents[e.previousNeighborIndex].eventID],i=playback.orderOfEvents[e.previousNeighborIndex].relevant);var s=e.clipNumber+"-"+r.ID,o=e.clipNumber+"-"+r.documentID;$("#pre-"+o).scrollTo($("#"+s)),i&&n?($("#"+s).css("background","#ebaa7c"),setTimeout(function(){$("#"+s).remove()},playback.speed)):$("#"+s).remove()}function createDocument(e){var t=events[playback.orderOfEvents[playback.position].eventID],n=e.clipNumber+"-"+t.documentID,r=$("<a/>",{href:"#"+n,id:"tab-"+n}).text(t.newName);$("<li/>",{id:"li-"+n,"class":"clip-"+e.clipNumber}).append(r).appendTo($("#documentTabs"));var i=$("<div/>",{id:n,"class":"documentDiv clip-"+e.clipNumber}),s=$("<pre/>",{id:"pre-"+n,"class":"document"});i.append(s).appendTo($("#documents")),$("#documents").tabs("refresh"),r.trigger("click"),setupPlaybackInterface()}function delDocument(e){var t=events[e.eventID],n=e.clipNumber+"-"+t.documentID;$("#li-"+n).remove(),$("#"+n).remove(),$("#documents").tabs("refresh")}function hideClip(e){$(".clip-"+e.clipNumber).hide(),playback.playing&&playPause()}function showClip(e){$(".clip-"+e.clipNumber+1).remove(),$(".clip-"+e.clipNumber).show()}function commentClick(e,t){var n=comments[e.substr("comment-".length)],r=events[n.eventID],i=t.split("-"),s=parseInt(i[1]),o=findEvent(r.ID,s)+1;step(o,!1),console.log(n),highlightElements(s+"-"+n.startHighlightedEventID,s+"-"+n.endHighlightedEventID)}function clipClick(e,t){var n=t.split("-"),r=n[n.length-1],i=storyboard.clips[r],s=findClipClearEvent(i.clipNumber)+6;step(s,!1)}function storyboardClick(){step(0,!1)}function setupSpeed(){$("#speedHolder").hide(),$("#speedSlider").slider({animate:!1,min:0,max:100,orientation:"vertical",step:1,range:"min",value:101-playback.speed/5,slide:function(e,t){changeSpeed(t.value)},stop:function(e,t){$("#speedHolder").has($(e.toElement)).length==0&&$("#speedHolder").data("leaveTimeout",setTimeout(hideSpeedSlider,1500)),$("#speedHolder").data("sliding",!1),$("#speedHolder .ui-slider-handle").blur()},start:function(e,t){$("#speedHolder").data("sliding",!0)}}),$("#speedSlider .ui-slider-handle").hover(function(e){showSpeedTooltip()}),$("#speedHolder").mouseleave(function(){$("#speedHolder").data("sliding")||$("#speedHolder").data("leaveTimeout",setTimeout(hideSpeedSlider,1500))}),$("#speedHolder").mouseenter(function(){clearTimeout($("#speedHolder").data("leaveTimeout"))}),$("#speed").mouseleave(function(){$("#speedHolder").is(":visible")&&$("#speedHolder").data("leaveTimeout",setTimeout(hideSpeedSlider,1500))}),$("#speed").mouseenter(function(){clearTimeout($("#speedHolder").data("leaveTimeout"))})}function setupSpeedSlider(){$("#speedHolder").height($(window).height()/3),$("#speedHolder").css("left",$("#speed").position().left+9+"px")}function toggleSpeedSlider(){$("#speedHolder").slideToggle("fast")}function hideSpeedSlider(){$("#speedHolder").slideUp("fast")}function showSpeedTooltip(){$("#speed-tool").remove(),clearTimeout($("#speedSlider").data("timeout"));var e=$("<div/>",{"class":"custom-tooltip",id:"speed-tool"}).text(playback.speed/1e3+" sec");e.appendTo("body");var t=$("#speedHolder").position().top+$("#speedSlider .ui-slider-handle").position().top+e.height(),n=$("#speedHolder").position().left-e.width();e.css({left:n,top:t}),$("#speedSlider").data("timeout",setTimeout(function(){$("#speed-tool").remove()},1e3))}function changeSpeed(e){playback.speed=505-e*5,localStorage.setItem("speed",playback.speed),playback.playing&&(playPause(),playPause()),showSpeedTooltip()}function setupSettings(){$("#settingsMenu").dialog({autoOpen:!1,resizable:!0,draggable:!0,height:220,width:200,title:"Settings",open:function(e,t){$("#curFontSize").val(playback.fontSize),$("#curFontSize").keypress(function(e){e.which==13&&changeFontSize(parseInt($("#curFontSize").val()))})}})}function toggleSettings(){$("#settingsMenu").dialog("isOpen")?$("#settingsMenu").dialog("close"):$("#settingsMenu").dialog("open")}function decFontSize(){changeFontSize(parseInt(playback.fontSize)-2)}function incFontSize(){changeFontSize(parseInt(playback.fontSize)+2)}function changeFontSize(e){playback.fontSize=e,$("#fsStyles").html("pre.document { font-size: "+playback.fontSize+"px; }"),localStorage.setItem("size",playback.fontSize),$("#curFontSize").val(playback.fontSize)}function getSavedSettings(){localStorage.getItem("speed")!=null&&(playback.speed=parseInt(localStorage.getItem("speed"))),localStorage.getItem("size")!=null&&(playback.fontSize=parseInt(localStorage.getItem("size")))}function setupPlayback(){getSavedSettings(),changeFontSize(playback.fontSize),$("#stepBack").mousedown(function(){playback.playing&&playPause(),clearInterval($(this).data("timeout")),clearInterval($("#stepForward").data("timeout")),stepBackward(1),$(this).data("timeout",setInterval("stepBackward(1)",playback.speed))}).bind("mouseup mouseleave",function(){clearInterval($(this).data("timeout"))}),$("#stepForward").mousedown(function(){playback.playing&&playPause(),clearInterval($(this).data("timeout")),clearInterval($("#stepBackward").data("timeout")),stepForward(1),$(this).data("timeout",setInterval("stepForward(1)",playback.speed))}).bind("mouseup mouseleave",function(){clearInterval($(this).data("timeout"))}),$("#documents").tabs({collapsible:!1,hide:!1,active:1});var e=getSearchData();"storyboardID"in e?(playback.type="storyboard",storyboard.storyboardID=e.storyboardID):"clipID"in e?(playback.type="clip",clip.clipID=e.clipID):"sessionID"in e&&(playback.type="selection",playPlaybackSession(e.sessionID)),$("#playbackArea").focus(),setupPlaybackInterface(),setupPlaybackRightclickMenu(),events.CLEAR={ID:"CLEAR",type:"CLEAR",developerGroupID:null},startGettingEvents()}function setupPlaybackInterface(){$("#playbackArea").height($(window).height()-10-$("header").outerHeight());var e=$(window).height();e-=$("#commands").height(),e-=$.scrollbarWidth(),e-=$("header").outerHeight();var t="#comments { height: "+e+"px; }";e-=$("#documentTabs").outerHeight(),t+="\npre.document { height: "+e+"px; }",$("#interfaceStyles").html(t);var n=$(window).width()-$("#movement").outerWidth()-$("#etcCommands").outerWidth()-70;$("#locationHolder").width(n),$("#timestamp").width(n),setupSpeedSlider()}function playPause(){clearInterval($("#stepForward").data("timeout")),clearInterval($("#stepBackward").data("timeout")),playback.playing?(playback.playing=!1,clearInterval(playback.player),$("#pauseIcon").hide(),$("#playIcon").show()):(playback.playing=!0,playback.player=setInterval("stepForward(1)",playback.speed),$("#pauseIcon").show(),$("#playIcon").hide())}function clearEverything(){events={},eventGrabber.done=!1,eventGrabber.currentIndex=0,eventFilters.done=!1,playback.orderOfEvents=[],playback.relevantEvents=[],$("#locationSlider").slider("option","value",0),$("#locationSlider").slider("option","max",0),$("#documents").html("<ul id='documentTabs'></ul>\n<div id='developerPictures'></div>"),$("#documentTabs").tabs({collapsible:!1,hide:!1,active:1})}function changeDevGroup(e){($("#developerPictures").data("group")===undefined||$("#developerPictures").data("group")!=e)&&e in developerGroups&&($("#developerPictures").data("group",e),$("#developerPictures").html(""),$.each(developerGroups[e].developers,function(e,t){$("<img/>",{"class":"devPicture",src:developers[t].gravatar}).appendTo("#developerPictures")}))}function findEvent(e,t){var n=0;while(playback.orderOfEvents[n].clipNumber<t)n++;while(playback.orderOfEvents[n].eventID!=e)n++;return n}function findClipClearEvent(e){currentClipNumber=0;for(var t=0;t<playback.relevantEvents.length;t++){events[playback.orderOfEvents[playback.relevantEvents[t]].eventID].type=="CLEAR"&&currentClipNumber++;if(currentClipNumber==e)return playback.relevantEvents[t]}}function startGettingEvents(){events=playbackData.events,playback.orderOfEvents=playbackData.orderOfEvents,playback.relevantEvents=playbackData.relevantEvents,comments=playbackData.comments,developers=playbackData.developers,developerGroups=playbackData.developerGroups,storyboard=playbackData.storyboard,showDescription(storyboard),showClipInfo(0),$("#locationSlider").slider("option","max",playback.relevantEvents.length-1),$("#mode").text(storyboard.name),setupPlaybackInterface(),$("#playbackArea").focus(),showCommentSection()}function setupPlaybackRightclickMenu(){}var debug=!1;$.scrollbarWidth=function(){var e,t,n;return n===undefined&&(e=$("<div/>").css({width:50,height:50,overflow:"auto"}).append("<div/>"),e.appendTo("body"),t=e.children(),n=t.innerWidth()-t.height(99).innerWidth(),e.remove()),n},$.fn.fadeRemove=function(){this.stop().animate({opacity:"0"},{duration:100,easing:"linear",done:function(){this.remove()}})};var comments={},sessionID,storyboard={storyboardID:null,clips:[],name:"",description:"",developerGroupID:null},events={},playback={speed:100,fontSize:14,orderOfEvents:[],relevantEvents:[],playing:!1,position:0,player:null,type:"filtered",clipNumber:0};$(window).resize(function(){setupPlaybackInterface()}),$(document).ready(function(){setupMovement(),setupSpeed(),setupKeyboardShortcuts(),setupPlayback(),setupSettings()});